(()=>{"use strict";var e={3:e=>{e.exports=require("path")},156:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function o(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,a)}d((r=r.apply(e,t||[])).next())})},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.info=void 0,t.init=g,t.exit=E;const i=s(n(268)),o=n(895),a=n(790),d=n(162),c=n(958),u=new o.Chalk,l="[SillyTavern-ValueTracker-Plugin]";let h,f;function g(e){return r(this,void 0,void 0,function*(){const t=i.default.json();console.log(u.blue(l),"Initializing Value Tracker Plugin..."),h=new d.CrossExtensionReader,console.log(u.green(l),"CrossExtensionReader initialized"),f=new a.ApiEndpoints(h),console.log(u.green(l),"API endpoints initialized"),(0,c.setCrossExtensionReader)(h),console.log(u.green(l),"CrossExtensionReader set for other extensions"),e.use("/",f.getRouter()),console.log(u.green(l),"API routes registered"),e.get("/probe",(e,t)=>(console.log(u.blue(l),"Probe endpoint accessed from IP:",e.ip||e.socket.remoteAddress),t.sendStatus(204))),e.post("/ping",t,(e,t)=>r(this,void 0,void 0,function*(){try{console.log(u.blue(l),"Ping endpoint accessed from IP:",e.ip||e.socket.remoteAddress);const{message:n}=e.body;return console.log(u.blue(l),"Ping received with message:",n),t.json({message:`Pong! ${n}`})}catch(e){return console.error(u.red(l),"Ping request failed",e),t.status(500).send("Internal Server Error")}})),console.log(u.green(l),"Plugin loaded successfully!")})}function E(){return r(this,void 0,void 0,function*(){console.log(u.yellow(l),"Plugin exit started"),h&&(yield h.closeAll(),console.log(u.yellow(l),"All extension databases closed")),console.log(u.yellow(l),"Plugin exited successfully")})}t.info={id:"valuetracker",name:"Value Tracking Plugin",description:"A simple value tracking plugin for SillyTavern server with database support."};const I={init:g,exit:E,info:t.info};t.default=I},162:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function o(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,a)}d((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0}),t.CrossExtensionReader=void 0;const s=n(941),i=n(599),o=new(n(895).Chalk),a="[ValueTracker-CrossExtensionReader]";t.CrossExtensionReader=class{constructor(){this.extensionDatabases=new Map}registerExtensionDatabase(e){return r(this,void 0,void 0,function*(){const t=(0,i.validateExtensionId)(e);if(console.log(o.blue(a),"Registering database for extension:",t),this.extensionDatabases.has(t)){const e=this.extensionDatabases.get(t);e&&(console.log(o.yellow(a),"Closing existing database for extension:",t),yield e.close())}const n=yield s.DatabaseManager.create(t);this.extensionDatabases.set(t,n),console.log(o.green(a),"Database registered successfully for extension:",t)})}deregisterExtensionDatabase(e){return r(this,void 0,void 0,function*(){const t=(0,i.validateExtensionId)(e);console.log(o.blue(a),"Deregistering database for extension:",t);const n=this.extensionDatabases.get(t);n?(yield n.close(),this.extensionDatabases.delete(t),console.log(o.green(a),"Database deregistered successfully for extension:",t)):console.log(o.yellow(a),"Database not found for extension during deregistration:",t)})}getDbManager(e){const t=(0,i.validateExtensionId)(e);return this.extensionDatabases.get(t)||(console.log(o.yellow(a),"Database manager not found for extension:",t),null)}getFullCharacter(e,t){return r(this,void 0,void 0,function*(){const n=this.getDbManager(e);return n?n.getFullCharacter(t):null})}getFullInstance(e,t){return r(this,void 0,void 0,function*(){const n=this.getDbManager(e);return n?n.getFullInstance(t):null})}getInstanceData(e,t){return r(this,void 0,void 0,function*(){const n=this.getDbManager(e);return n?n.getData(t):{}})}getDataValue(e,t,n){return r(this,void 0,void 0,function*(){const r=this.getDbManager(e);if(r)return r.getDataValue(t,n)})}getAllCharacters(e){return r(this,void 0,void 0,function*(){const t=this.getDbManager(e);return t?t.getAllCharacters():[]})}getInstancesByCharacter(e,t){return r(this,void 0,void 0,function*(){const n=this.getDbManager(e);return n?n.getInstancesByCharacter(t):[]})}closeAll(){return r(this,void 0,void 0,function*(){if(console.log(o.yellow(a),"Closing all extension databases"),0!==this.extensionDatabases.size){for(const[e,t]of this.extensionDatabases)try{console.log(o.yellow(a),"Closing database for extension:",e),yield t.close(),console.log(o.green(a),"Successfully closed database for extension:",e)}catch(t){console.error(o.red(a),"Error closing database for extension",e+":",t)}this.extensionDatabases.clear(),console.log(o.green(a),"All extension databases closed successfully.")}else console.log(o.blue(a),"No extension databases to close")})}}},252:e=>{e.exports=require("express")},268:e=>{e.exports=require("body-parser")},518:e=>{e.exports=require("./sql.js")},599:(e,t)=>{function n(e){if("string"!=typeof e)throw new Error("Extension ID must be a string, got "+typeof e);if(null==e)throw new Error("Extension ID cannot be undefined or null");if(!e)throw new Error("Extension ID cannot be empty");let t,n=e;do{t=n,n=n.replace(/\.\.\//g,"").replace(/\.\.\\/g,"")}while(n!==t);if(n=n.replace(/[<>:"/\\|?*]/g,"_"),n=n.substring(0,255),!n)throw new Error("Extension ID became empty after sanitization");return n}Object.defineProperty(t,"__esModule",{value:!0}),t.sanitizeExtensionId=n,t.validateExtensionId=function(e){if("string"!=typeof e)throw new Error("Extension ID must be a string, got "+typeof e);if(null==e)throw new Error("Extension ID cannot be undefined or null");const t=n(e),r=t.trim();if(r.length<1)throw new Error("Extension ID must be at least 1 character");if(/^\s*$/.test(t))throw new Error("Extension ID cannot be only whitespace");if(r.startsWith("."))throw new Error("Extension ID cannot start with a dot");return r},t.isValidId=function(e){return!!e&&/^[a-zA-Z0-9_-]+$/.test(e)},t.isValidString=function(e){return"string"==typeof e&&e.trim().length>0},t.isValidObject=function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)},t.isValidJsonString=function(e){if("string"!=typeof e)return!1;try{return JSON.parse(e),!0}catch(e){return!1}},t.safeJsonParse=function(e){try{return JSON.parse(e)}catch(e){return null}},t.validateRequestBody=function(e,t){const n=[];for(const r of e)r in t&&void 0!==t[r]&&null!==t[r]||n.push(r);return{isValid:0===n.length,missingFields:n.length>0?n:void 0}}},790:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function o(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,a)}d((r=r.apply(e,t||[])).next())})},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ApiEndpoints=void 0;const i=s(n(252)),o=n(599),a=new(n(895).Chalk),d="[ValueTracker-ApiEndpoints]";t.ApiEndpoints=class{constructor(e){this.crossExtensionReader=e,this.router=i.default.Router(),console.log(a.green(d),"Initializing API endpoints..."),this.setupRoutes(),console.log(a.green(d),"API endpoints initialized successfully")}getExtensionIdFromHeader(e){return e.headers["x-extension-id"]||null}getRouter(){return this.router}setupRoutes(){this.router.post("/register",this.registerExtension.bind(this)),this.router.delete("/register",this.deregisterExtension.bind(this)),this.router.get("/characters",this.getAllCharacters.bind(this)),this.router.get("/characters/:id",this.getCharacter.bind(this)),this.router.post("/characters",this.upsertCharacter.bind(this)),this.router.delete("/characters/:id",this.deleteCharacter.bind(this)),this.router.get("/instances",this.getAllInstances.bind(this)),this.router.get("/instances/:id",this.getInstance.bind(this)),this.router.get("/characters/:characterId/instances",this.getInstancesByCharacter.bind(this)),this.router.post("/instances",this.upsertInstance.bind(this)),this.router.delete("/instances/:id",this.deleteInstance.bind(this)),this.router.get("/instances/:id/data",this.getInstanceData.bind(this)),this.router.get("/instances/:id/data/:key",this.getInstanceDataKey.bind(this)),this.router.post("/instances/:id/data",this.upsertInstanceData.bind(this)),this.router.put("/instances/:id/data",this.upsertInstanceData.bind(this)),this.router.delete("/instances/:id/data/:key",this.deleteInstanceDataKey.bind(this)),this.router.delete("/instances/:id/data",this.clearInstanceData.bind(this)),this.router.delete("/characters/:characterId/instances",this.deleteAllInstancesForCharacter.bind(this)),this.router.put("/instances/:id/data/override",this.overrideInstanceData.bind(this)),this.router.put("/instances/:id/data/merge",this.mergeInstanceData.bind(this)),this.router.put("/instances/:id/data/remove",this.removeInstanceDataKeys.bind(this)),this.router.get("/cross-extension/characters/:extensionId/:id",this.getCrossExtensionCharacter.bind(this)),this.router.get("/cross-extension/instances/:extensionId/:id",this.getCrossExtensionInstance.bind(this)),this.router.get("/cross-extension/instances/:extensionId/:id/data",this.getCrossExtensionInstanceData.bind(this)),this.router.get("/cross-extension/instances/:extensionId/:id/data/:key",this.getCrossExtensionInstanceDataKey.bind(this)),this.router.get("/cross-extension/characters/:extensionId",this.getCrossExtensionAllCharacters.bind(this)),this.router.get("/cross-extension/characters/:extensionId/:characterId/instances",this.getCrossExtensionInstancesByCharacter.bind(this)),console.log(a.green(d),"All routes registered successfully")}getAllCharacters(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n||!(0,o.isValidId)(n))return void t.status(400).json({error:"Valid extension ID is required in header: x-extension-id"});const r=this.crossExtensionReader.getDbManager(n);if(!r)return void t.status(404).json({error:`Database not found for extension: ${n}`});const s=yield r.getAllCharacters();t.json(s)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getCharacter(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params;if(!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid character ID is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});const i=yield s.getFullCharacter(r);if(!i)return void t.status(404).json({error:"Character not found"});t.json(i)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}upsertCharacter(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r,name:s}=e.body;if(!r||!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid character ID is required in body"});const i=this.crossExtensionReader.getDbManager(n);if(!i)return void t.status(404).json({error:`Database not found for extension: ${n}`});const a=yield i.upsertCharacter({id:r,name:s||void 0});t.json(a)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}deleteCharacter(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params;if(!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid character ID is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});if(!(yield s.deleteCharacter(r)))return void t.status(404).json({error:"Character not found"});t.json({success:!0})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getAllInstances(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{characterId:r}=e.query;if("string"!=typeof r||!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid characterId query parameter is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});const i=yield s.getInstancesByCharacter(r);t.json(i)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getInstance(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params;if(!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid instance ID is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});const i=yield s.getFullInstance(r);if(!i)return void t.status(404).json({error:"Instance not found"});t.json(i)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getInstancesByCharacter(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{characterId:r}=e.params;if(!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid character ID is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});const i=yield s.getInstancesByCharacter(r);t.json(i)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}upsertInstance(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r,characterId:s,name:i}=e.body;if(!(r&&(0,o.isValidId)(r)&&s&&(0,o.isValidId)(s)))return void t.status(400).json({error:"Valid instance ID and character ID are required"});const a=this.crossExtensionReader.getDbManager(n);if(!a)return void t.status(404).json({error:`Database not found for extension: ${n}`});const d=yield a.upsertInstance({id:r,characterId:s,name:i||void 0});t.json(d)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}deleteInstance(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params;if(!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid instance ID is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});if(!(yield s.deleteInstance(r)))return void t.status(404).json({error:"Instance not found"});t.json({success:!0})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getInstanceData(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params;if(!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid instance ID is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});const i=yield s.getData(r);t.json(i)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getInstanceDataKey(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r,key:s}=e.params;if(!(0,o.isValidId)(r)||!s)return void t.status(400).json({error:"Valid instance ID and key are required"});const i=this.crossExtensionReader.getDbManager(n);if(!i)return void t.status(404).json({error:`Database not found for extension: ${n}`});const a=yield i.getDataValue(r,s);t.json({[s]:a})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}upsertInstanceData(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params,{key:s,value:i}=e.body;if(!(0,o.isValidId)(r)||!s)return void t.status(400).json({error:"Valid instance ID and key are required"});const a=this.crossExtensionReader.getDbManager(n);if(!a)return void t.status(404).json({error:`Database not found for extension: ${n}`});yield a.upsertData(r,s,i),t.json({success:!0,key:s,value:i})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}deleteInstanceDataKey(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r,key:s}=e.params;if(!(0,o.isValidId)(r)||!s)return void t.status(400).json({error:"Valid instance ID and key are required"});const i=this.crossExtensionReader.getDbManager(n);if(!i)return void t.status(404).json({error:`Database not found for extension: ${n}`});if(!(yield i.deleteDataValue(r,s)))return void t.status(404).json({error:"Data key not found"});t.json({success:!0})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}clearInstanceData(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params;if(!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid instance ID is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});const i=yield s.clearInstanceData(r);t.json({success:i})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}deleteAllInstancesForCharacter(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{characterId:r}=e.params;if(!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid character ID is required"});const s=this.crossExtensionReader.getDbManager(n);if(!s)return void t.status(404).json({error:`Database not found for extension: ${n}`});const i=yield s.getInstancesByCharacter(r);let a=0;for(const e of i)(yield s.deleteInstance(e.id))&&a++;t.json({success:!0,deletedCount:a})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}overrideInstanceData(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params,s=e.body;if(!(0,o.isValidId)(r)||"object"!=typeof s||null===s)return void t.status(400).json({error:"Valid instance ID and data object are required"});const i=this.crossExtensionReader.getDbManager(n);if(!i)return void t.status(404).json({error:`Database not found for extension: ${n}`});yield i.clearInstanceData(r);for(const[e,t]of Object.entries(s))yield i.upsertData(r,e,t);t.json({success:!0,message:"Instance data overridden successfully"})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}mergeInstanceData(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params,s=e.body;if(!(0,o.isValidId)(r)||"object"!=typeof s||null===s)return void t.status(400).json({error:"Valid instance ID and data object are required"});const i=this.crossExtensionReader.getDbManager(n);if(!i)return void t.status(404).json({error:`Database not found for extension: ${n}`});for(const[e,t]of Object.entries(s))yield i.upsertData(r,e,t);t.json({success:!0,message:"Instance data merged successfully"})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}removeInstanceDataKeys(e,t){return r(this,void 0,void 0,function*(){try{const n=this.getExtensionIdFromHeader(e);if(!n)return void t.status(400).json({error:"Extension ID is required in header: x-extension-id"});const{id:r}=e.params,{keys:s}=e.body;if(!(0,o.isValidId)(r)||!Array.isArray(s))return void t.status(400).json({error:"Valid instance ID and keys array are required"});const i=this.crossExtensionReader.getDbManager(n);if(!i)return void t.status(404).json({error:`Database not found for extension: ${n}`});let a=0;for(const e of s)(yield i.deleteDataValue(r,e))&&a++;t.json({success:!0,removedCount:a})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}registerExtension(e,t){return r(this,void 0,void 0,function*(){try{const{extensionId:n}=e.body;if(!n||!(0,o.isValidId)(n))return void t.status(400).json({error:"Valid extension ID is required in body"});yield this.crossExtensionReader.registerExtensionDatabase(n),t.json({success:!0,message:`Extension ${n} registered successfully`})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}deregisterExtension(e,t){return r(this,void 0,void 0,function*(){try{const{extensionId:n}=e.body;if(!n||!(0,o.isValidId)(n))return void t.status(400).json({error:"Valid extension ID is required in body"});yield this.crossExtensionReader.deregisterExtensionDatabase(n),t.json({success:!0,message:`Extension ${n} deregistered successfully`})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getCrossExtensionCharacter(e,t){return r(this,void 0,void 0,function*(){try{const{extensionId:n,id:r}=e.params;if(!(0,o.isValidId)(n)||!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid extension ID and character ID are required"});const s=yield this.crossExtensionReader.getFullCharacter(n,r);if(!s)return void t.status(404).json({error:`Character not found in extension ${n}`});t.json(s)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getCrossExtensionInstance(e,t){return r(this,void 0,void 0,function*(){try{const{extensionId:n,id:r}=e.params;if(!(0,o.isValidId)(n)||!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid extension ID and instance ID are required"});const s=yield this.crossExtensionReader.getFullInstance(n,r);if(!s)return void t.status(404).json({error:`Instance not found in extension ${n}`});t.json(s)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getCrossExtensionInstanceData(e,t){return r(this,void 0,void 0,function*(){try{const{extensionId:n,id:r}=e.params;if(!(0,o.isValidId)(n)||!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid extension ID and instance ID are required"});const s=yield this.crossExtensionReader.getInstanceData(n,r);t.json(s)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getCrossExtensionInstanceDataKey(e,t){return r(this,void 0,void 0,function*(){try{const{extensionId:n,id:r,key:s}=e.params;if(!(0,o.isValidId)(n)||!(0,o.isValidId)(r)||!s)return void t.status(400).json({error:"Valid extension ID, instance ID, and key are required"});const i=yield this.crossExtensionReader.getDataValue(n,r,s);t.json({[s]:i})}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getCrossExtensionAllCharacters(e,t){return r(this,void 0,void 0,function*(){try{const{extensionId:n}=e.params;if(!(0,o.isValidId)(n))return void t.status(400).json({error:"Valid extension ID is required"});const r=yield this.crossExtensionReader.getAllCharacters(n);t.json(r)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}getCrossExtensionInstancesByCharacter(e,t){return r(this,void 0,void 0,function*(){try{const{extensionId:n,characterId:r}=e.params;if(!(0,o.isValidId)(n)||!(0,o.isValidId)(r))return void t.status(400).json({error:"Valid extension ID and character ID are required"});const s=yield this.crossExtensionReader.getInstancesByCharacter(n,r);t.json(s)}catch(e){const n=e instanceof Error?e.message:"Unknown error";t.status(500).json({error:n})}})}}},895:e=>{e.exports=require("chalk")},941:function(e,t,n){var r,s=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,s)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&s(t,e,n[o]);return i(t,e),t}),a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function o(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,a)}d((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0}),t.DatabaseManager=void 0;const d=o(n(943)),c=o(n(3)),u=n(895),l=n(599),h=n(518),f=h.default||h,g=new u.Chalk,E="[ValueTracker-DatabaseManager]";class I{constructor(e){this.extensionId=(0,l.validateExtensionId)(e),this.dbPath=c.join(process.cwd(),"db",`${this.extensionId}.db`)}static create(e){return a(this,void 0,void 0,function*(){if(!e||"string"!=typeof e)throw console.error(g.red(E),`Invalid extension ID provided: ${e}`),new Error("A valid extension ID is required to create a DatabaseManager.");const t=new I(e);if(!I.SQL){console.log(g.blue(E),"Initializing SQL.js...");try{I.SQL=yield f(),console.log(g.green(E),"SQL.js initialized successfully.")}catch(e){throw console.error(g.red(E),"Failed to initialize SQL.js:",e),new Error("Could not initialize sql.js. Make sure sql-wasm.js and sql-wasm.wasm are in the dist directory.")}}return yield t.initializeDb(),t})}isOpen(){return void 0!==this.db&&null!==this.db}getExtensionId(){return this.extensionId}getDbPath(){return this.dbPath}upsertCharacter(e){return a(this,void 0,void 0,function*(){if(!this.isOpen())throw new Error("Database is closed");if(!e.id)throw new Error("Character ID is required");console.log(g.blue(E),"Upserting character:",e.id);const t=(new Date).toISOString();(yield this.getCharacter(e.id))?this.db.run("UPDATE characters SET name = COALESCE(?, name), updated_at = ? WHERE id = ?",[e.name||null,t,e.id]):this.db.run("INSERT INTO characters (id, name, created_at, updated_at) VALUES (?, ?, ?, ?)",[e.id,e.name||null,t,t]);const n=yield this.getCharacter(e.id);if(!n)throw new Error("Failed to retrieve character after upsert");return yield this.flushToDisk(),n})}getCharacter(e){return a(this,void 0,void 0,function*(){const t=this.db.prepare("SELECT id, name, created_at, updated_at FROM characters WHERE id = ?"),n=t.getAsObject({":id":e});return t.free(),0===Object.keys(n).length?null:{id:n.id,name:n.name,createdAt:new Date(n.created_at),updatedAt:new Date(n.updated_at)}})}getAllCharacters(){return a(this,void 0,void 0,function*(){const e=this.db.prepare("SELECT id, name, created_at, updated_at FROM characters"),t=[];for(;e.step();){const n=e.getAsObject();t.push({id:n.id,name:n.name,createdAt:new Date(n.created_at),updatedAt:new Date(n.updated_at)})}return e.free(),t})}deleteCharacter(e){return a(this,void 0,void 0,function*(){if(!e)throw new Error("Character ID is required");if(!(yield this.getCharacter(e)))return!1;const t=yield this.getInstancesByCharacter(e);for(const e of t)this.db.run("DELETE FROM data WHERE instance_id = ?",[e.id]);return this.db.run("DELETE FROM instances WHERE character_id = ?",[e]),this.db.run("DELETE FROM characters WHERE id = ?",[e]),yield this.flushToDisk(),!0})}upsertInstance(e){return a(this,void 0,void 0,function*(){if(!this.isOpen())throw new Error("Database is closed");if(!e.id||!e.characterId)throw new Error("Instance ID and character ID are required");const t=(new Date).toISOString();(yield this.getInstance(e.id))?this.db.run("UPDATE instances SET name = COALESCE(?, name), character_id = COALESCE(?, character_id), updated_at = ? WHERE id = ?",[e.name||null,e.characterId,t,e.id]):this.db.run("INSERT INTO instances (id, character_id, name, created_at, updated_at) VALUES (?, ?, ?, ?, ?)",[e.id,e.characterId,e.name||null,t,t]);const n=yield this.getInstance(e.id);if(!n)throw new Error("Failed to retrieve instance after upsert");return yield this.flushToDisk(),n})}getInstance(e){return a(this,void 0,void 0,function*(){const t=this.db.prepare("SELECT id, character_id, name, created_at, updated_at FROM instances WHERE id = ?"),n=t.getAsObject({":id":e});return t.free(),0===Object.keys(n).length?null:{id:n.id,characterId:n.character_id,name:n.name,createdAt:new Date(n.created_at),updatedAt:new Date(n.updated_at)}})}getInstancesByCharacter(e){return a(this,void 0,void 0,function*(){const t=this.db.prepare("SELECT id, character_id, name, created_at, updated_at FROM instances WHERE character_id = ?"),n=[];for(t.bind([e]);t.step();){const e=t.getAsObject();n.push({id:e.id,characterId:e.character_id,name:e.name,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)})}return t.free(),n})}deleteInstance(e){return a(this,void 0,void 0,function*(){if(!e)throw new Error("Instance ID is required");return!!(yield this.getInstance(e))&&(this.db.run("DELETE FROM data WHERE instance_id = ?",[e]),this.db.run("DELETE FROM instances WHERE id = ?",[e]),yield this.flushToDisk(),!0)})}upsertData(e,t,n){return a(this,void 0,void 0,function*(){if(!this.isOpen())throw new Error("Database is closed");if(!e||!t)throw new Error("Instance ID and key are required");const r=(new Date).toISOString(),s="object"==typeof n?JSON.stringify(n):String(n);this.db.run("INSERT OR REPLACE INTO data (instance_id, key, value, updated_at) VALUES (?, ?, ?, ?)",[e,t,s,r]),yield this.flushToDisk()})}getData(e){return a(this,void 0,void 0,function*(){const t=this.db.prepare("SELECT key, value FROM data WHERE instance_id = ?"),n={};for(t.bind([e]);t.step();){const e=t.getAsObject(),r=e.key,s=e.value;try{n[r]=JSON.parse(s)}catch(e){n[r]=s}}return t.free(),n})}getDataValue(e,t){return a(this,void 0,void 0,function*(){if(!e||!t)throw new Error("Instance ID and key are required");const n=this.db.prepare("SELECT value FROM data WHERE instance_id = ? AND key = ?"),r=n.getAsObject({":instance_id":e,":key":t});if(n.free(),!r||!r.value)return;const s=r.value;try{return JSON.parse(s)}catch(e){return s}})}deleteDataValue(e,t){return a(this,void 0,void 0,function*(){if(!e||!t)throw new Error("Instance ID and key are required");return void 0!==(yield this.getDataValue(e,t))&&(this.db.run("DELETE FROM data WHERE instance_id = ? AND key = ?",[e,t]),yield this.flushToDisk(),!0)})}getFullCharacter(e){return a(this,void 0,void 0,function*(){const t=yield this.getCharacter(e);if(!t)return null;const n=yield this.getInstancesByCharacter(e);return{character:t,instances:yield Promise.all(n.map(e=>a(this,void 0,void 0,function*(){const t=yield this.getData(e.id);return{instance:e,data:t}})))}})}getFullInstance(e){return a(this,void 0,void 0,function*(){const t=yield this.getInstance(e);return t?{instance:t,data:yield this.getData(e)}:null})}clearInstanceData(e){return a(this,void 0,void 0,function*(){if(!e)throw new Error("Instance ID is required");const t=yield this.getData(e);return 0!==Object.keys(t).length&&(this.db.run("DELETE FROM data WHERE instance_id = ?",[e]),yield this.flushToDisk(),!0)})}close(){return a(this,void 0,void 0,function*(){console.log(g.yellow(E),"Closing database connection for extension:",this.extensionId);try{yield this.flushToDisk(),this.db.close(),console.log(g.green(E),"Database connection closed successfully.")}catch(e){console.error(g.red(E),"Error closing database:",e)}})}flushToDisk(){return a(this,void 0,void 0,function*(){try{const e=this.db.export();yield d.writeFile(this.dbPath,e),console.log(g.green(E),"Database flushed to disk successfully.")}catch(e){throw console.error(g.red(E),"Error flushing database to disk:",e),e}})}initializeDb(){return a(this,void 0,void 0,function*(){console.log(g.blue(E),"Initializing database for extension:",this.extensionId),console.log(g.blue(E),"Database path:",this.dbPath);const e=c.dirname(this.dbPath);let t;yield this.ensureDirectoryExists(e),console.log(g.blue(E),"Ensured database directory exists:",e);try{const e=yield d.readFile(this.dbPath);t=new Uint8Array(e),console.log(g.blue(E),"Loaded existing database from file.")}catch(e){if("ENOENT"!==e.code)throw e;console.log(g.blue(E),"No existing database file found. A new one will be created.")}this.db=new I.SQL.Database(t),this.initializeTables()})}ensureDirectoryExists(e){return a(this,void 0,void 0,function*(){try{yield d.mkdir(e,{recursive:!0})}catch(e){if("EEXIST"!==e.code)throw e}})}initializeTables(){console.log(g.blue(E),"Initializing database tables..."),this.db.exec("\n            CREATE TABLE IF NOT EXISTS characters (\n                id TEXT PRIMARY KEY,\n                name TEXT,\n                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n            );\n            CREATE TABLE IF NOT EXISTS instances (\n                id TEXT PRIMARY KEY,\n                character_id TEXT NOT NULL,\n                name TEXT,\n                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (character_id) REFERENCES characters (id)\n            );\n            CREATE TABLE IF NOT EXISTS data (\n                instance_id TEXT NOT NULL,\n                key TEXT NOT NULL,\n                value TEXT,\n                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n                PRIMARY KEY (instance_id, key),\n                FOREIGN KEY (instance_id) REFERENCES instances (id)\n            );\n            CREATE INDEX IF NOT EXISTS idx_instances_character_id ON instances(character_id);\n            CREATE INDEX IF NOT EXISTS idx_data_instance_id ON data(instance_id);\n        "),console.log(g.green(E),"Database tables initialized successfully.")}}t.DatabaseManager=I},943:e=>{e.exports=require("fs/promises")},958:(e,t)=>{let n;Object.defineProperty(t,"__esModule",{value:!0}),t.setCrossExtensionReader=function(e){n=e},t.getCrossExtensionReader=function(){if(!n)throw new Error("CrossExtensionReader not initialized. Call setCrossExtensionReader first.");return n}}},t={},n=function n(r){var s=t[r];if(void 0!==s)return s.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(156);module.exports=n})();